resamples  = resamples_kfold,
param_info = parameters(wflw_spec_rand_forest_tune_3),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_rf_3 <- wflw_spec_rand_forest_tune_3 %>%
finalize_workflow(select_best(tune_results_rand_forest_3, "rmse"))
# + Random Forest - Ranger 4 ----
# wflw_spec_rf_4 <- workflow() %>%
#     add_model(
#         rand_forest() %>% set_engine("ranger")
#     ) %>%
#     add_recipe(recipe_spec_4_alt)
wflw_spec_rand_forest_tune_4 <- workflow() %>%
add_model(
rand_forest_tune_spec
) %>%
add_recipe(recipe_spec_4_alt)
tic()
set.seed(123)
tune_results_rand_forest_4 <- wflw_spec_rand_forest_tune_4 %>%
tune_grid(
resamples  = resamples_kfold,
param_info = parameters(wflw_spec_rand_forest_tune_4),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_rf_4 <- wflw_spec_rand_forest_tune_4 %>%
finalize_workflow(select_best(tune_results_rand_forest_4, "rmse"))
# ** Results tuned ----
tune_results_rand_forest_1 %>% show_best("rmse", n = 1) %>%
bind_rows(tune_results_rand_forest_2 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_rand_forest_3 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_rand_forest_4 %>% show_best("rmse", n = 1)) %>%
rowid_to_column() %>%
arrange(mean)
# + SVM 1 ----
# wflw_spec_svm_1 <- workflow() %>%
#     add_model(
#         spec = svm_rbf(mode = "regression") %>% set_engine("kernlab")
#     ) %>%
#     add_recipe(recipe_spec_1_alt)
svm_rbf_tune_spec <-
svm_rbf(cost = tune(),
rbf_sigma = tune(),
margin = tune()) %>%
set_engine('kernlab') %>%
set_mode('regression')
wflw_spec_svm_tune_1 <- workflow() %>%
add_model(
svm_rbf_tune_spec
) %>%
add_recipe(recipe_spec_1_alt)
tic()
set.seed(123)
tune_results_svm_rbf_1 <- wflw_spec_svm_tune_1 %>%
tune_grid(
resamples  = resamples_kfold,
param_info = parameters(wflw_spec_svm_tune_1),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_svm_rbf_1 <- wflw_spec_svm_tune_1 %>%
finalize_workflow(select_best(tune_results_svm_rbf_1, "rmse"))
# + SVM 2 ----
# wflw_spec_svm_2 <- workflow() %>%
#     add_model(
#         spec = svm_rbf(mode = "regression") %>% set_engine("kernlab")
#     ) %>%
#     add_recipe(recipe_spec_2_alt)
wflw_spec_svm_tune_2 <- workflow() %>%
add_model(
svm_rbf_tune_spec
) %>%
add_recipe(recipe_spec_2_alt)
tic()
set.seed(123)
tune_results_svm_rbf_2 <- wflw_spec_svm_tune_2 %>%
tune_grid(
resamples  = resamples_kfold,
param_info = parameters(wflw_spec_svm_tune_2),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_svm_rbf_2 <- wflw_spec_svm_tune_2 %>%
finalize_workflow(select_best(tune_results_svm_rbf_2, "rmse"))
# + SVM 3 ----
# wflw_spec_svm_3 <- workflow() %>%
#     add_model(
#         spec = svm_rbf(mode = "regression") %>% set_engine("kernlab")
#     ) %>%
#     add_recipe(recipe_spec_3_alt)
wflw_spec_svm_tune_3 <- workflow() %>%
add_model(
svm_rbf_tune_spec
) %>%
add_recipe(recipe_spec_3_alt)
tic()
set.seed(123)
tune_results_svm_rbf_3 <- wflw_spec_svm_tune_3 %>%
tune_grid(
resamples  = resamples_kfold,
param_info = parameters(wflw_spec_svm_tune_3),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_svm_rbf_3 <- wflw_spec_svm_tune_3 %>%
finalize_workflow(select_best(tune_results_svm_rbf_3, "rmse"))
# + SVM 4 ----
# wflw_spec_svm_4 <- workflow() %>%
#     add_model(
#         spec = svm_rbf(mode = "regression") %>% set_engine("kernlab")
#     ) %>%
#     add_recipe(recipe_spec_4_alt)
wflw_spec_svm_tune_4 <- workflow() %>%
add_model(
svm_rbf_tune_spec
) %>%
add_recipe(recipe_spec_4_alt)
tic()
set.seed(123)
tune_results_svm_rbf_4 <- wflw_spec_svm_tune_4 %>%
tune_grid(
resamples  = resamples_kfold,
param_info = parameters(wflw_spec_svm_tune_4),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_svm_rbf_4 <- wflw_spec_svm_tune_4 %>%
finalize_workflow(select_best(tune_results_svm_rbf_4, "rmse"))
# ** Results tuned ----
tune_results_svm_rbf_1 %>% show_best("rmse", n = 1) %>%
bind_rows(tune_results_svm_rbf_2 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_svm_rbf_3 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_svm_rbf_4 %>% show_best("rmse", n = 1)) %>%
rowid_to_column() %>%
arrange(mean)
# + XGBoost 1 ----
# wflw_spec_xgboost_1 <- workflow() %>%
#     add_model(
#         boost_tree() %>% set_engine("xgboost")
#     ) %>%
#     add_recipe(recipe_spec_1_alt)
boost_tree_xgboost_tune_spec <-
boost_tree(
tree_depth = tune(),
trees = tune(),
learn_rate = tune(),
min_n = tune(),
loss_reduction = tune(),
sample_size = tune(),
stop_iter = tune()
) %>%
set_engine('xgboost') %>%
set_mode('regression')
wflw_spec_xgboost_tune_1 <- workflow() %>%
add_model(
boost_tree_xgboost_tune_spec
) %>%
add_recipe(recipe_spec_1_alt)
tic()
set.seed(123)
tune_results_xgboost_1 <- wflw_spec_xgboost_tune_1 %>%
tune_grid(
resamples  = resamples_kfold,
param_info = parameters(boost_tree_xgboost_tune_spec),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_xgboost_1 <- wflw_spec_xgboost_tune_1 %>%
finalize_workflow(select_best(tune_results_xgboost_1, "rmse"))
# + XGBoost 2 ----
# wflw_spec_xgboost_2 <- workflow() %>%
#     add_model(
#         boost_tree() %>% set_engine("xgboost")
#     ) %>%
#     add_recipe(recipe_spec_2_alt)
wflw_spec_xgboost_tune_2 <- workflow() %>%
add_model(
boost_tree_xgboost_tune_spec
) %>%
add_recipe(recipe_spec_2_alt)
tic()
set.seed(123)
tune_results_xgboost_2 <- wflw_spec_xgboost_tune_2 %>%
tune_grid(
resamples  = resamples_kfold,
param_info = parameters(boost_tree_xgboost_tune_spec),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_xgboost_2 <- wflw_spec_xgboost_tune_2 %>%
finalize_workflow(select_best(tune_results_xgboost_2, "rmse"))
# + XGBoost 3 ----
# wflw_spec_xgboost_3 <- workflow() %>%
#     add_model(
#         boost_tree() %>% set_engine("xgboost")
#     ) %>%
#     add_recipe(recipe_spec_3_alt)
wflw_spec_xgboost_tune_3 <- workflow() %>%
add_model(
boost_tree_xgboost_tune_spec
) %>%
add_recipe(recipe_spec_3_alt)
tic()
set.seed(123)
tune_results_xgboost_3 <- wflw_spec_xgboost_tune_3 %>%
tune_grid(
resamples  = resamples_kfold,
param_info = parameters(boost_tree_xgboost_tune_spec),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_xgboost_3 <- wflw_spec_xgboost_tune_3 %>%
finalize_workflow(select_best(tune_results_xgboost_3, "rmse"))
# + XGBoost 4 ----
# wflw_spec_xgboost_4 <- workflow() %>%
#     add_model(
#         boost_tree() %>% set_engine("xgboost")
#     ) %>%
#     add_recipe(recipe_spec_4_alt)
wflw_spec_xgboost_tune_4 <- workflow() %>%
add_model(
boost_tree_xgboost_tune_spec
) %>%
add_recipe(recipe_spec_4_alt)
tic()
set.seed(123)
tune_results_xgboost_4 <- wflw_spec_xgboost_tune_4 %>%
tune_grid(
resamples  = resamples_kfold,
param_info = parameters(boost_tree_xgboost_tune_spec),
grid = 25,
control = control_grid(verbose = TRUE, allow_par = TRUE)
)
toc()
wflw_spec_xgboost_4 <- wflw_spec_xgboost_tune_4 %>%
finalize_workflow(select_best(tune_results_xgboost_4, "rmse"))
# ** Results tuned ----
tune_results_kknn_1 %>% show_best("rmse", n = 1) %>%
bind_rows(tune_results_kknn_2 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_kknn_3 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_kknn_4 %>% show_best("rmse", n = 1)) %>%
rowid_to_column() %>%
arrange(mean)
# ** Results tuned ----
tune_results_mars_1 %>% show_best("rmse", n = 1) %>%
bind_rows(tune_results_mars_2 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_mars_3 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_mars_4 %>% show_best("rmse", n = 1)) %>%
rowid_to_column() %>%
arrange(mean)
# ** Results tuned ----
tune_results_prophet_boost_1 %>% show_best("rmse", n = 1) %>%
bind_rows(tune_results_prophet_boost_2 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_prophet_boost_3 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_prophet_boost_4 %>% show_best("rmse", n = 1)) %>%
rowid_to_column() %>%
arrange(mean)
# ** Results tuned ----
tune_results_rand_forest_1 %>% show_best("rmse", n = 1) %>%
bind_rows(tune_results_rand_forest_2 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_rand_forest_3 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_rand_forest_4 %>% show_best("rmse", n = 1)) %>%
rowid_to_column() %>%
arrange(mean)
# ** Results tuned ----
tune_results_svm_rbf_1 %>% show_best("rmse", n = 1) %>%
bind_rows(tune_results_svm_rbf_2 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_svm_rbf_3 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_svm_rbf_4 %>% show_best("rmse", n = 1)) %>%
rowid_to_column() %>%
arrange(mean)
# ** Results tuned ----
tune_results_xgboost_1 %>% show_best("rmse", n = 1) %>%
bind_rows(tune_results_xgboost_2 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_xgboost_3 %>% show_best("rmse", n = 1)) %>%
bind_rows(tune_results_xgboost_4 %>% show_best("rmse", n = 1)) %>%
rowid_to_column() %>%
arrange(mean)
runApp()
# Plotting
library(plotly)
# Shiny
library(shiny)
library(shinyWidgets)
library(shinythemes)
library(shinyjs)
library(DT)
library(reactable)
# Modeling
library(tidymodels)
library(modeltime)
library(modeltime.ensemble)
library(rules)
# engines
library(Cubist)  # cubist
library(glmnet)  # glm
library(kknn)    # Nearest Neighbors
library(earth)   # MARS
library(ranger)  # random forest
library(kernlab) # SVM
library(xgboost) # xgboost
# Data
# library(tidyquant)
library(cbsodataR)
library(tidyquant)
# # Data Wrangling
library(janitor)
# Time Series
library(lubridate)
library(timetk)
# Core
library(tidyverse)
# SETTINGS ---------------------------------------------------------------------
# set language to English
Sys.setlocale("LC_ALL","English")
# * file names ----
fn_pump_prices    <- "00_local_data/cbs_daily_pump_prices.RDS"
fn_housing_prices <-
"00_local_data/cbs_quarterly_housing_prices.RDS"
fn_air_passengers <- "00_local_data/cbs_monthly_air_passengers.RDS"
fn_dow <- "00_local_data/dow.RDS"
# set start date for time series with too many observations for shinyapps to keep in memory
ts_start <- str_c(year(Sys.Date() %-time% "2 years 6 months"), "-", month(Sys.Date() %-time% "5 years 1 month"))
# SOURCE FUNCTIONS -------------------------------------------------------------
source("autoforecast/data_functions.R")
source("autoforecast/plot_functions.R")
source("autoforecast/ui_functions.R")
# GET DATA ---------------------------------------------------------------------
# * daily fuel prices ----
tryCatch(
(
cbs_get_data("80416ENG") %>%
cbs_add_label_columns() %>%
clean_names() %>%
mutate(date = ymd(periods)) %>%
select(
date,
petrol = euro95_1,
diesel = diesel_2,
lpg = lpg_3
) %>%
filter_by_time(.date_var   = date,
.start_date = ts_start,
.end_date   = "end") %>%
saveRDS(file = fn_pump_prices)
),
finally = cbs_pump_prices_tbl <<-
read_rds(fn_pump_prices)
)
# * quarterly housing prices ----
tryCatch(
(
cbs_get_data("83910ENG") %>%
cbs_add_label_columns() %>%
cbs_add_date_column() %>%
clean_names() %>%
filter(periods_freq == "Q") %>%
select(
date                   = periods_date,
type_of_dwelling       = type_of_dwelling_label,
average_purchase_price = average_purchase_price_7
)  %>%
mutate(across(where(is.integer), as.numeric)) %>%
pivot_wider(names_from  = type_of_dwelling,
values_from = average_purchase_price) %>%
saveRDS(file = fn_housing_prices)
),
finally = cbs_housing_prices_tbl <<- read_rds(fn_housing_prices)
)
# * monthly aviation figures ----
tryCatch(
(
cbs_get_data("37478ENG") %>%
cbs_add_label_columns() %>%
cbs_add_date_column() %>%
clean_names() %>%
filter(periods_freq == "M") %>%
select(date = periods_date,
airports_label,
contains("total_passengers")) %>%
rename_all(list(
~ stringr::str_replace_all(., "total_", "")
)) %>%
rename_all(list(
~ stringr::str_replace_all(., "_[0-9]{1,2}$", "")
)) %>%
mutate(across(where(is.integer), as.numeric)) %>%
pivot_wider(names_from = 2, values_from = 3) %>%
saveRDS(file = fn_air_passengers)
),
finally = cbs_air_passengers_tbl <<- read_rds(fn_air_passengers)
)
get_dow_data()
View(get_dow_data)
dow_raw_tbl <- NULL
symbols <- tq_index("DOW") %>% pull(symbol) %>% sort()
for (i in symbols) {
stock_tbl <- tq_get(i)
dow_raw_tbl <- dow_raw_tbl %>% bind_rows(stock_tbl)
}
dow_raw_tbl
dow_raw_tbl %>%
group_by(symbol) %>%
summarise(date = last(date))
dow_raw_tbl %>%
group_by(symbol) %>%
summarise(date = last(date),
volume = last(volume),
adjusted = last(adjusted))
dow_raw_tbl %>%
group_by(symbol) %>%
summarise(date = last(date),
volume = last(volume),
adjusted = last(adjusted)) %>%
ungroup() %>%
mutate(trade_value = volume*adjusted) %>%
arrange(desc(trade_value))
dow_raw_tbl %>%
group_by(symbol) %>%
summarise(date = last(date),
volume = last(volume),
adjusted = last(adjusted)) %>%
ungroup() %>%
mutate(trade_value = volume*adjusted) %>%
arrange(desc(trade_value)) %>%
slice(1:6)
dow_raw_tbl %>%
group_by(symbol) %>%
summarise(date = last(date),
volume = last(volume),
adjusted = last(adjusted)) %>%
ungroup() %>%
mutate(trade_value = volume*adjusted) %>%
arrange(desc(trade_value)) %>%
dplyr::slice(6)
dow_raw_tbl %>%
group_by(symbol) %>%
summarise(date = last(date),
volume = last(volume),
adjusted = last(adjusted)) %>%
ungroup() %>%
mutate(trade_value = volume*adjusted) %>%
arrange(desc(trade_value)) %>%
dplyr::slice(1:6)
dow_raw_tbl %>%
group_by(symbol) %>%
summarise(date = last(date),
volume = last(volume),
adjusted = last(adjusted)) %>%
ungroup() %>%
mutate(trade_value = volume*adjusted) %>%
arrange(desc(trade_value)) %>%
dplyr::slice(1:6) %>%
pull(symmbol)
dow_raw_tbl %>%
group_by(symbol) %>%
summarise(date = last(date),
volume = last(volume),
adjusted = last(adjusted)) %>%
ungroup() %>%
mutate(trade_value = volume*adjusted) %>%
arrange(desc(trade_value)) %>%
dplyr::slice(1:6) %>%
pull(symbol)
selected_stocks <- dow_raw_tbl %>%
group_by(symbol) %>%
summarise(date = last(date),
volume = last(volume),
adjusted = last(adjusted)) %>%
ungroup() %>%
mutate(trade_value = volume*adjusted) %>%
arrange(desc(trade_value)) %>%
dplyr::slice(1:6) %>%
pull(symbol)
dow_raw_tbl %>%
dplyr::filter(symbol %in% selected_stocks) %>%
select(date, symbol, adjusted) %>%
distinct() %>%
group_by(symbol) %>%
summarise_by_time(.date_var = date,
adjusted  = last(adjusted),
.type     = "ceiling",
.by       = "week") %>%
ungroup() %>%
pivot_wider(names_from  = 1,
values_from = 3,
values_fn  = {mean}) %>%
select(-DOW)
dow_raw_tbl %>%
dplyr::filter(symbol %in% selected_stocks) %>%
select(date, symbol, adjusted) %>%
distinct() %>%
group_by(symbol) %>%
summarise_by_time(.date_var = date,
adjusted  = last(adjusted),
.type     = "ceiling",
.by       = "week") %>%
ungroup() %>%
pivot_wider(names_from  = 1,
values_from = 3,
values_fn  = {mean})
